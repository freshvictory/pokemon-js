<!DOCTYPE html>

<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>Pok√©mon Types</title>

        <!-- PWA settings -->
        <link rel="manifest" href="/manifest.json">
        <meta name="theme-color" content="#000000">
        <link rel="shortcut icon" href="/images/PremiereBall-192.png">
        <link rel="apple-touch-icon" sizes="192x192" href="/images/PremiereBall-192.png">
        <link rel="apple-touch-icon" sizes="512x512" href="/images/PremiereBall-512.png">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

        <!-- <link rel="preload" href="router.js" as="script" crossorigin="anonymous" /> -->
        <!-- <link rel="preload" href="types.js" as="script" crossorigin="anonymous" /> -->

        <link rel="stylesheet" href="/main.css"/>
        <link rel="stylesheet" href="/types.css"/>
        <script src="/index.js" type="module"></script>
        <script type="module">
          import { define } from './component.js';
          import { types } from './types.js';

          window.component = (opts) => customElements.define(
            opts.id,
            define(opts)
          );
          window.types = types;
        </script>
    </head>
    <body>
        <noscript>
            This app requires JavaScript. Sorry about that!
        </noscript>
        <div id="app">
            <div id="list-container">
                <ul id="list">
                    <li><type-link type="normal"></type-link></li>
                    <li><type-link type="fighting"></type-link></li>
                    <li><type-link type="flying"></type-link></li>
                    <li><type-link type="poison"></type-link></li>
                    <li><type-link type="ground"></type-link></li>
                    <li><type-link type="rock"></type-link></li>
                    <li><type-link type="bug"></type-link></li>
                    <li><type-link type="ghost"></type-link></li>
                    <li><type-link type="steel"></type-link></li>
                    <li><type-link type="fire"></type-link></li>
                    <li><type-link type="water"></type-link></li>
                    <li><type-link type="grass"></type-link></li>
                    <li><type-link type="electric"></type-link></li>
                    <li><type-link type="psychic"></type-link></li>
                    <li><type-link type="ice"></type-link></li>
                    <li><type-link type="dragon"></type-link></li>
                    <li><type-link type="fairy"></type-link></li>
                    <li><type-link type="dark"></type-link></li>
                </ul>
            </div>
        </div>
        <internal-link href="/" title="Home" id="shield"></internal-link>
        <type-legend></type-legend>
    </body>
</html>


<!-- Type Link -->
<template id="type-link">
  <div class="details">
    <type-list class="list" id="counter-list" list="counter"></type-list>
    <type-list class="list" id="resistant-list" list="resistant"></type-list>
  </div>
  <internal-link id="link" class="info">
    <type-icon id="icon" slot="content"></type-icon>
  </internal-link>

<style>
:host {
  --size: 60px;

  --edge-inset: 35px;
}

:host {
  transition:
    transform 500ms cubic-bezier(0.175, 0.885, 0.32, 1.275),
    filter 300ms;
  will-change: transform;
  filter: grayscale(0);

  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: var(--size);
  height: var(--size);

  border-radius: 50%;

  overflow: visible;
  position: relative;
  box-shadow: 0 0 10px 0;
}

:host([hidden]) {
  display: none;
}

:host([checked]) {
  transform: scale(1.25);
  z-index: 2;
}

:host([checked]) .details {
  transform: scale(1) translate(-50%, -50%);
}


/* Screen edge overrides */

:host([data_placement*='left']) .details {
  --angle-multiplier: 1;
}

:host([data_placement*='right']) .list {
  --angle-multiplier: -1;
}

:host([data_placement*='top']) .list {
  --starting-angle: 90deg;
}

:host([data_placement='bottom center']) .list {
  --starting-angle: -90deg;
}

:host([checked]) {
  --m-x: 0;
  --m-y: 0;
  transform:
    scale(1.25)
    translateX(calc(var(--m-x) * var(--edge-inset)))
    translateY(calc(var(--m-y) * var(--edge-inset)));
}

:host([checked][data_placement='top left'].half),
:host([checked][data_placement*='left'].full) {
  --m-x: 1;
}

:host([checked][data_placement='top right'].half),
:host([checked][data_placement*='right'].full) {
  --m-x: -1;
}

:host([checked][data_placement='bottom left'].half),
:host([checked][data_placement='bottom right'].half),
:host([checked][data_placement*='bottom'].full) {
  --m-y: -1;
}

:host([checked][data_placement*='top'].full) {
  --m-y: 1;
}

.details {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  pointer-events: none;
}

.info {
  text-decoration: none;
  color: inherit;
  
  box-sizing: border-box;

  border-radius: 50%;

  position: relative;
}
</style>
</template>
<script type="module">
component({
  id: 'type-link',
  attributes: [ 'type', 'checked', 'list', 'secondary' ],
  data: {
    type: undefined,
    secondary: undefined
  },
  refs: [ 'counter-list', 'resistant-list', 'link', 'icon' ],
  connected: (data, refs) => {
    const type = types.get(data.type, data.secondary);

    refs.host.id = 'link-' + type.primary;
    refs.host.style = `color: var(--c-${type.primary})`;

    refs['counter-list'].setAttribute('type', type.primary);
    refs['resistant-list'].setAttribute('type', type.primary);

    refs.link.setAttribute('href', type.primary);
    refs.link.title = type.name;

    refs.icon.setAttribute('type', type.primary);
  },
  changed: (data, refs, name, oldValue, newValue) => {
    let type = types.get(data.type, data.secondary);

    const calculateInset = (relationship) => {
      refs.host.classList[type.relationships[relationship].length > 5
        ? 'add' : 'remove']('half');
      refs.host.classList[type.relationships[relationship].length > 9
        ? 'add' : 'remove']('full');
    };

    const calculatePlacement = () => {
      const rect = refs.host.getBoundingClientRect();
      const horiz = rect.x < rect.width
        ? 'left'
        : (window.innerWidth - rect.left) < rect.right
          ? 'right'
          : 'center';
      const vert = rect.y < rect.height
        ? 'top'
        : (window.innerHeight - rect.bottom) < (rect.height + 40)
          ? 'bottom'
          : 'center';

      return vert + ' ' + horiz;
    };

    if (name === 'checked') {
      if (newValue === null) {
        data.secondary = '';
        refs.icon.data.secondary = '';
        refs[data.list+'-list'].removeAttribute('checked');
      } else {
        const placement = calculatePlacement();
        refs.icon.setAttribute('data_placement', placement);
        refs.host.setAttribute('data_placement', placement);
        refs[data.list+'-list'].setAttribute('checked', newValue);
      }
      type = types.get(data.type, data.secondary);
      refs.link.data.href = (newValue === null ? type.id : '/');
    } else if (name === 'list') {
      if (oldValue) {
        refs[oldValue+'-list'].removeAttribute('checked');
      }
      refs[newValue+'-list'].setAttribute('checked', '');
      calculateInset(newValue);
    } else if (name === 'secondary') {
      refs['counter-list'].data.secondary = data.secondary;
      refs['resistant-list'].data.secondary = data.secondary;
      refs.icon.data.secondary = data.secondary;
      calculateInset(data.list);
    }
  }
});
</script>


<!-- Type List -->
<template id="type-list">
  <ul id="list">
    <li id="relationship" class="wrapper">
      <div class="relationship">
        <div class="icon">
          <type-icon id="icon"></type-icon>
        </div>
        <triangle-icon id="triangle"></triangle-icon>
      </div>
    </li>
  </ul>

<style>
:host {
  --angle: 33deg;
  --starting-angle: 0deg;
  --angle-multiplier: 1;
}

ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

#list {
  width: 60px;
  height: 60px;
}

.wrapper {
  --num: 0;

  --angle-calc: calc(var(--angle-multiplier) * (var(--starting-angle)
    + var(--angle) * var(--num)));

  position: absolute;
  bottom: 50%;
  left: 50%;
  transform-origin: bottom center;
  transform: translate(-50%) rotate(var(--angle-calc));
}

:host([checked]) .wrapper .relationship {
  transform: translateY(-45px);
}

:host([checked]) .wrapper.emph .relationship {
  transform: translateY(-50px);
}

.wrapper.emph type-icon {
  --c-border: var(--color);
}

.relationship {
  transition: transform 300ms;
  will-change: transform;
  pointer-events: auto;
}

.icon {
  transform: rotate(calc(-1 * var(--angle-calc)));
  border-radius: 50%;
}

:host([checked]) .icon {
  box-shadow: 0 0 10px 0;
}

triangle-icon {
  left: 50%;
  transform: translateX(-50%) translateY(-6px);
  position: absolute;
}

.emph triangle-icon {
  --width: 9px;
  --height: 9px;
}

triangle-icon.toward {
  top: 46%;
}

triangle-icon.away {
  transform: translateX(-50%) scale(-1) translateY(-6px);
}
</style>
</template>
<script type="module">
import { shouldEmphasize } from './types.js';

component({
  id: 'type-list',
  attributes: [ 'type', 'secondary', 'list' ],
  data: {
    type: undefined,
    secondary: undefined,
    list: undefined
  },
  refs: [ 'list', 'relationship', 'icon', 'triangle' ],
  render: (data, refs) => {
    if (!data.type) { return; }
    const type = types.get(data.type, data.secondary);

    refs.list.innerHTML = '';
    refs.icon.style = '--icon-size: 30px';
    refs.triangle.style = `--color: var(--c-${data.list})`;
    refs.triangle.classList.add('away');

    type.relationships[data.list]
      .sort((a, b) => {
        return shouldEmphasize(data.list, type, a) ? -1
          : shouldEmphasize(data.list, type, b) ? 1
          : 0;
      })
      .map((t, counter) => {
        const emphasize = shouldEmphasize(data.list, type, t);

        refs.relationship.classList[emphasize ? 'add' : 'remove']('emph');
        refs.relationship.style = `--num: ${counter}; ${
          emphasize ? `--color: var(--c-${data.list})` : ''
        }`;
        refs.icon.setAttribute('type', t);
        refs.relationship.style.color = `var(--c-${t})`;

        const li = refs.relationship.cloneNode(true);
        refs.list.appendChild(li);
      });
  }
});
</script>


<!-- Type Icon -->
<template id="type-icon">
  <div id="wrapper">
    <img id="icon" class="icon"/>
  </div>
  <img id="secondary" class="icon secondary hide"/>

<style>
:host {
  --icon-size: 60px;
  --c-border: transparent;
}

.hide {
  display: none !important;
}

#wrapper {
  border-radius: 50%;
  overflow: visible;
}

.icon {
  border-radius: 50%;
  width: var(--icon-size);
  height: var(--icon-size);
  display: flex;
  margin: 0;
  padding: 0;
  border: 0;
}

.icon.secondary {
  width: calc(var(--icon-size) / 2);
  height: calc(var(--icon-size) / 2);
  position: absolute;
  right: 33px;
  top: 33px;
  box-shadow: -1px px 5px 0;
}

:host([data_placement*='bottom']) .icon.secondary,
:host([data_placement*='right']) .icon.secondary {
  left: 33px;
  box-shadow: 1px 1px 5px 0;
  right: auto;
}
</style>
</template>
<script type="module">
component({
  id: 'type-icon',
  attributes: [ 'type', 'secondary' ],
  data: {
    type: undefined,
    secondary: undefined
  },
  refs: [ 'icon', 'secondary', 'wrapper' ],
  render: (data, refs) => {
    const type = types.get(data.type, data.secondary);

    refs.wrapper.style.backgroundColor = `var(--c-${type.primary})`;
    
    refs.icon.alt = type.name;
    refs.icon.src = `/images/types/${type.primary}.svg`;

    if (type.secondary) {
      refs.secondary.alt = type.name;
      refs.secondary.src = `/images/types/${type.secondary}.svg`;
      refs.secondary.style.color = `var(--c-${type.secondary})`;
      refs.secondary.classList.remove('hide');
    } else {
      refs.secondary.classList.add('hide');
    }
  }
});
</script>


<!-- Type Legend -->
<template id="type-legend">
  <div id="against" class="group">
    <input type="radio" id="counter" name="against" class="button"/>
    <label for="counter" id="counter-label" class="label">
      <triangle-icon></triangle-icon><span>Good counters</span>
    </label>

    <input type="radio" id="resistant" name="against" class="button"/>
    <label for="resistant" id="resistant-label" class="label">
      <triangle-icon></triangle-icon><span>Bad counters</span>
    </label>
  </div>

<style>
:host {
  border-radius: 20px;
  background-color: var(--c-background-light);
  padding: 5px;
}

.group {
  display: grid;
  grid-auto-columns: max-content;
  grid-auto-flow: column;
  gap: 5px;
}

input[type=radio] {
  display: none;
}

.label {
  display: flex;
  flex-direction: row;
  align-items: center;
  position: relative;
  padding: 5px 10px;
  border-radius: 15px;
  cursor: pointer;
  background-color: var(--c-background-light);
  transition: none;
}

#counter-label {
  --c-highlighted: var(--c-counter-light);
}

#counter-label > triangle-icon {
  --color: var(--c-counter);
}

triangle-icon {
  --width: 0.5em;
  --height: 0.5em;

  padding-right: 10px;
}

#resistant-label {
  --c-highlighted: var(--c-resistant-light);
}

#resistant-label > triangle-icon {
  --color: var(--c-resistant);
}

:host([selected='counter']) #counter-label,
:host([selected='resistant']) #resistant-label {
  background-color: var(--c-highlighted);
  color: #000;
  transition: background-color 200ms;
}
</style>
</template>
<script type="module"> 
component({
  id: 'type-legend',
  refs: [
    'counter-label',
    'resistant-label'
  ],
  render: (data, refs) => {
    const updateRoute = (id) => {
      window.router.route(window.location.pathname, { list: id });
    };
    refs['counter-label'].addEventListener('click', () => updateRoute('counter'));
    refs['resistant-label'].addEventListener('click', () => updateRoute('resistant'));
  }
});
</script>


<!-- Triangle Icon -->
<template id="triangle-icon">
  <div class="triangle"></div>

<style>
:host {
  --color: #69c423;

  --width: 5px;
  --height: 5px;
  --border-radius: 50%;
}


/* Adapted from https://stackoverflow.com/a/14451916 */

.triangle {
  position: relative;
  background-color: var(--color);
  text-align: left;
}

.triangle:before,
.triangle:after {
  content: '';
  position: absolute;
  background-color: inherit;
}

.triangle,
.triangle:before,
.triangle:after {
	width:  var(--width);
	height: var(--height);
  border-top-right-radius: var(--border-radius);
}

.triangle {
  transform:
    rotate(-60deg)
    skewX(-30deg)
    scale(1, 0.866);
}

.triangle:before {
  transform:
    rotate(-135deg)
    skewX(-45deg)
    scale(1.414, 0.707)
    translate(0, -50%);
}

.triangle:after {
  transform:
    rotate(135deg)
    skewY(-45deg)
    scale(0.707, 1.414)
    translate(50%);
}
</style>
</template>
<script type="module">
component({ id: 'triangle-icon' });
</script>


<!-- Internal Link -->
<template id="internal-link">
  <a id="link"><slot name="content"></slot></a>

<style>
#link {
  width: 100%;
  height: 100%;
  display: block;
}
</style>
</template>
<script type="module">
import { Navigation } from '../router.js';

component({
  id: 'internal-link',
  attributes: [ 'href', 'title' ],
  data: { href: undefined, title: undefined },
  refs: [ 'link' ], 
  connected: (data, refs) => {
    refs.link.href = data.href;
    refs.link.title = data.title || '';
    refs.link.onclick = (e) => {
      /*
       * If we're trying to open the link in a new tab,
       * don't preventDefault(). Otherwise, we're clicking
       * normally and should handle it ourselves.
       *
       * https://stackoverflow.com/a/20025627
       */ 
      if (
        !(
          (
            e.type == 'click' 
            || e.type == 'mousedown'
            || e.type == 'mouseup'
          )
          &&
          (
            e.which > 1
            || e.button > 1
            || e.ctrlKey
            || e.shiftKey
            || e.metaKey
          )
        )
      ) {
        e.preventDefault();
        Navigation.navigate(data.href);
      }
    };
  }
})
</script>
